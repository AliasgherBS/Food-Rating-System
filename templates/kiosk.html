{% extends "base.html" %}

{% block title %}{{ company.name }} - Food Rating{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', path='/css/kiosk.css') }}">
{% endblock %}

{% block header %}
<header class="kiosk-header">
    <div class="header-content">
        <div class="company-info">
            <h1 class="company-name">{{ company.name }}</h1>
            <span class="company-type">
                {% if company.type == "static" %}
                    Static Menu - Rate All Items
                {% else %}
                    Cafeteria - Select Items You Ate
                {% endif %}
            </span>
        </div>
        <div class="date-info">
            <i class="fas fa-calendar"></i>
            <span id="current-date"></span>
        </div>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="kiosk-container" data-company-type="{{ company.type.value }}">
    <div class="rating-section">
        <div class="instructions">
            {% if company.type == "static" %}
                <h3><i class="fas fa-star"></i> Please rate all items below</h3>
                <p>All items must be rated before you can submit your feedback.</p>
            {% else %}
                <h3><i class="fas fa-utensils"></i> Select and rate the items you ate</h3>
                <p>Only rate the items you actually consumed today.</p>
            {% endif %}
        </div>
        
        <div class="menu-items" id="menu-items">
            {% for item in menu_items %}
            <div class="menu-item" data-item-id="{{ item.id }}" data-item-name="{{ item.name }}">
                <div class="item-info">
                    <h4 class="item-name">{{ item.name }}</h4>
                    {% if item.description %}
                        <p class="item-description">{{ item.description }}</p>
                    {% endif %}
                </div>
                
                {% if company.type == "cafeteria" %}
                <div class="item-selector">
                    <label class="checkbox-container">
                        <input type="checkbox" class="item-checkbox" onchange="toggleItemSelection(this)">
                        <span class="checkmark"></span>
                        <span class="checkbox-label">I ate this</span>
                    </label>
                </div>
                {% endif %}
                
                                            <div class="rating-container {% if company.type == 'cafeteria' %}hidden{% endif %}">
                                <div class="rating-emoji">
                                    <button class="emoji-btn" data-rating="1" onclick="setRating(this, 1)">üòû</button>
                                    <button class="emoji-btn" data-rating="2" onclick="setRating(this, 2)">üòê</button>
                                    <button class="emoji-btn" data-rating="3" onclick="setRating(this, 3)">üôÇ</button>
                                    <button class="emoji-btn" data-rating="4" onclick="setRating(this, 4)">üòä</button>
                                    <button class="emoji-btn" data-rating="5" onclick="setRating(this, 5)">üòç</button>
                                </div>
                    <div class="rating-text">
                        <span class="rating-label">Tap to rate</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    
    <div class="submit-section">
        <div class="progress-info">
            <div class="progress-text">
                <span id="progress-text">
                    {% if company.type == "static" %}
                        Rate all {{ menu_items|length }} items to continue
                    {% else %}
                        Select at least 1 item to continue
                    {% endif %}
                </span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>
        
        <button class="submit-btn" id="submit-btn" onclick="submitRatings()" disabled>
            <i class="fas fa-paper-plane"></i>
            Submit Ratings
        </button>
    </div>
</div>

<!-- Thank You Modal -->
<div class="modal" id="thank-you-modal">
    <div class="modal-content">
        <div class="thank-you-icon">
            <i class="fas fa-heart"></i>
        </div>
        <h2>Thank You!</h2>
        <p>Your feedback has been submitted successfully.</p>
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
        <p class="redirect-text">Returning to menu in <span id="countdown">3</span> seconds...</p>
    </div>
</div>

<script>
const companyId = '{{ company.id }}';
const menuId = '{{ menu.id }}';
const companyType = '{{ company.type }}';
const menuItems = {{ menu_items_json | safe }};

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Set current date
    const today = new Date();
    document.getElementById('current-date').textContent = today.toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });
    
    updateProgress();
});

let ratings = {};
let selectedItems = new Set();

function toggleItemSelection(checkbox) {
    const menuItem = checkbox.closest('.menu-item');
    const itemId = menuItem.dataset.itemId;
    const ratingContainer = menuItem.querySelector('.rating-container');
    
    if (checkbox.checked) {
        selectedItems.add(itemId);
        ratingContainer.classList.remove('hidden');
    } else {
        selectedItems.delete(itemId);
        ratingContainer.classList.add('hidden');
        delete ratings[itemId];
        
        // Reset rating buttons
        const emojiButtons = ratingContainer.querySelectorAll('.emoji-btn');
        emojiButtons.forEach(btn => btn.classList.remove('selected'));
        ratingContainer.querySelector('.rating-label').textContent = 'Tap to rate';
    }
    
    updateProgress();
}

function setRating(button, rating) {
    const menuItem = button.closest('.menu-item');
    const itemId = menuItem.dataset.itemId;
    const itemName = menuItem.dataset.itemName;
    const ratingContainer = menuItem.querySelector('.rating-container');
    
    // Update ratings object
    ratings[itemId] = {
        item_id: itemId,
        item_name: itemName,
        score: rating
    };
    
    // Update UI
    const emojiButtons = ratingContainer.querySelectorAll('.emoji-btn');
    emojiButtons.forEach(btn => btn.classList.remove('selected'));
    button.classList.add('selected');
    
    const ratingTexts = ['', 'Bad', 'Okay', 'Good', 'Great', 'Amazing']; // Index 0 unused, 1-5 used
    ratingContainer.querySelector('.rating-label').textContent = ratingTexts[rating];
    
    updateProgress();
}

function updateProgress() {
    const progressText = document.getElementById('progress-text');
    const progressFill = document.getElementById('progress-fill');
    const submitBtn = document.getElementById('submit-btn');
    
    let canSubmit = false;
    let progressPercentage = 0;
    let progressMessage = '';
    
    if (companyType === 'static') {
        const totalItems = menuItems.length;
        const ratedItems = Object.keys(ratings).length;
        progressPercentage = (ratedItems / totalItems) * 100;
        
        if (ratedItems === totalItems) {
            canSubmit = true;
            progressMessage = `All ${totalItems} items rated - Ready to submit!`;
        } else {
            progressMessage = `${ratedItems}/${totalItems} items rated`;
        }
    } else {
        const selectedCount = selectedItems.size;
        const ratedCount = Object.keys(ratings).length;
        
        if (selectedCount === 0) {
            progressMessage = 'Select at least 1 item to continue';
            progressPercentage = 0;
        } else if (ratedCount === selectedCount && selectedCount > 0) {
            canSubmit = true;
            progressMessage = `${ratedCount} item(s) rated - Ready to submit!`;
            progressPercentage = 100;
        } else {
            progressMessage = `${ratedCount}/${selectedCount} selected items rated`;
            progressPercentage = selectedCount > 0 ? (ratedCount / selectedCount) * 100 : 0;
        }
    }
    
    progressText.textContent = progressMessage;
    progressFill.style.width = progressPercentage + '%';
    submitBtn.disabled = !canSubmit;
    
    if (canSubmit) {
        submitBtn.classList.add('ready');
    } else {
        submitBtn.classList.remove('ready');
    }
}

async function submitRatings() {
    const submitBtn = document.getElementById('submit-btn');
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
    
    try {
        const response = await fetch('/api/ratings', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                company_id: companyId,
                menu_id: menuId,
                ratings: Object.values(ratings)
            })
        });
        
        if (response.ok) {
            const result = await response.json();
            showThankYouModal();
        } else {
            throw new Error('Failed to submit ratings');
        }
    } catch (error) {
        console.error('Error submitting ratings:', error);
        alert('Failed to submit ratings. Please try again.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Ratings';
    }
}

function showThankYouModal() {
    const modal = document.getElementById('thank-you-modal');
    modal.classList.add('active');
    
    let countdown = 3;
    const countdownElement = document.getElementById('countdown');
    
    const timer = setInterval(() => {
        countdown--;
        countdownElement.textContent = countdown;
        
        if (countdown <= 0) {
            clearInterval(timer);
            window.location.reload();
        }
    }, 1000);
}
</script>
{% endblock %} 